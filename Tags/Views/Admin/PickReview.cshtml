@model PickReview

@{
    ViewBag.Title = "Select Graphs in Review ";
}
<h2>@ViewBag.Title<div id="reviewcur"></div></h2>
<div class="row-fluid">
@using (var form = Html.Bootstrap().Begin(new Form("PickedReview", "Admin").Id("pickreviewform")))
{
    <div class="col-md-5">
        @Html.HiddenFor(m => m.DeletedReviews)
        @Html.HiddenFor(m => m.Cancel)
        @Html.HiddenFor(m => m.ReviewId)
        @Html.HiddenFor(m => m.EditSchedule)
        @Html.ListBoxFor(m => m.picked, Model.graphs, new { size = 18 })
    </div>
    <div class="col-md-6">
        <table id="reviews" class="table table-striped table-hover table-condensed table-bordered">
            <thead>
                <tr>
                    <th>Review Name</th>
                    <th>Schedule</th>
                    <th>
                        <button class="btn btn-primary btn-xs" id="undodelete" title="Undo deletions">
                            <i class="fa fa-undo"></i>
                        </button>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr title="Edit Row">
                    <td rowspan="2">
@form.FormGroup().TextBoxFor(m=>m.NewReview).Tooltip("Apply name and schedule to selected graphs for review").Class("input-sm").Label().Class("sr-only")
                        </td><td>
                    <div id="cron">
                    </div>
                    </td>
                    <td rowspan="2">
                        @Html.Bootstrap().SubmitButton().Text("Save").Id("save").Style(ButtonStyle.Success)
                    </td>
                </tr>
                <tr>
                    <td>@form.FormGroup().TextBoxFor(m=>m.NewSchedule).Tooltip("Raw cron expression").Class("input-sm").Label().Class("sr-only")</td>
                </tr>
                @Html.DisplayFor(m => m.reviews)
            </tbody>
        </table>
    </div>
}
</div>

@section scripts{
    <script src="~/Scripts/jqCron.js" type="text/javascript"></script>
    <script type="text/javascript">
        var editMode = false;
        var cron;
        var $review = $('#@Html.IdFor(m => m.ReviewId)')
        var $viewBox = $('#@Html.IdFor(m => m.NewReview)')
        var $schedule = $('#@Html.IdFor(m => m.NewSchedule)')
        var $upschedule = $('#@Html.IdFor(m => m.EditSchedule)')
        var charts = [];
        @Html.Raw(Model.snippet)
        var demo1 = $('select[name="picked"]').bootstrapDualListbox({
            nonSelectedListLabel: 'Non-selected',
            selectedListLabel: 'Selected',
            preserveSelectionOnMove: true
        });
        $viewBox.prop('readonly', ($('#bootstrap-duallistbox-selected-list_picked > option').length > 0));
        $('#cancel').on('click',function () {
            $('#@Html.IdFor(m=>m.Cancel)').val(true);
        });
        $('#save').on('click', function () {
            var s = cron.getCron();
            $upschedule.val(s);
        });
        $('.reviewrow').on('click', function (e) {
            var chart = $(this).data('id');
            var sched = $(this).data('schedule');
            demo1.val(charts[chart]);
            demo1.bootstrapDualListbox('refresh', true);
            $viewBox.val($('td.reviewname', $(this)).text());
            cron.setCron(sched.substr(2).replace(/\?/g, "*"));
            //$schedule.val(sched.substr(2).replace(/\?/g, "*"));
            $review.val(chart);
        });

        $('.reviewdel').on('click', function (e) {
            var id = $(this).data('id');
            var graph = $(this).data('reviewid');
            if ($.trim($(this).text()) == $viewBox.val())
                $viewBox.val('');
            $('#review_' + id).remove();
            var $dead = $('#@Html.IdFor(m=>m.DeletedReviews)');
            $dead.val($dead.val()+","+graph);
        });
        demo1.on('change', function () {
             $viewBox.prop('readonly', ($('#bootstrap-duallistbox-selected-list_picked > option').length == 0));
        });
        $(function () {
            cron = $schedule.jqCron({
                enabled_minute: true,
                multiple_dom: true,
                multiple_month: true,
                multiple_mins: true,
                multiple_dow: true,
                multiple_time_hours: true,
                multiple_time_minutes: true,
                default_period: 'week',
                no_reset_button: false,
                lang: 'en'
            }).jqCronGetInstance();
        });
    </script>
}